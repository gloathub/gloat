#!/usr/bin/env bash

set -euo pipefail

export GLOAT_VERSION=0.1.1

main() (
  self=${BASH_SOURCE[0]}
  [[ -L $self ]] && self=$(readlink -f "$self")
  root=$(cd -P "$(dirname "$self")/.." && pwd -P)

  PATH=$(make --quiet --no-print-directory -C "$root" path)
  export PATH

  setup

  exec bb "$root/bin/gloat.clj" "$@"
)

setup() (
  [[ $(command -v bb) == "$root/.cache/.local/bin/bb" ]] && return

  if interactive; then
    GREEN=$'\e[1;92m'
    YELLOW=$'\e[1;93m'
    BLUE=$'\e[1;96m'
    BOLD=$'\e[1m'
    RESET=$'\e[0m'

    deps="$YELLOW(bb, glj, go, ys)"

    >&2 cat <<...
$BLUE==> Installing gloat dependencies $deps$BLUE locally into:$RESET

    $root/.cache/.local/

${BOLD}Press Enter to continue (or Ctrl-C to cancel)...$RESET
...

      read -r < /dev/tty
  fi

  make -C "$root" path-deps

  if interactive; then
    >&2 echo -e "\n$GREEN==> All gloat dependencies installed.$RESET"
  fi
)

interactive() { [[ -t 0 && -t 1 && -t 2 ]]; }

main "$@"
